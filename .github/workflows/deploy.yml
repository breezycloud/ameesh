name: Production

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Setup dotnet
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: '8.0.*'

    - name: Install WASM workloads
      run: dotnet workload install wasm-tools

    - name: Install dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Publish
      run: dotnet publish -c Release -o ./publish
    
    - name: Copy files via SSH Password
      uses: appleboy/scp-action@master    
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.VPS_PORT }}
        source: ./publish/
        target: ${{ secrets.VPS_TARGET }}
        timeout: 10m
        rm: true


    - name: Run SSH command
      uses: appleboy/ssh-action@v0.1.10
      with:        
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: sudo systemctl restart ameesh.service