@using Shared.Enums
@inject IReturnService Service
<MudDataGrid T="ReturnedProduct" Items="Data!.OrderByDescending(x => x.Date)" Outlined="true" Context="ctx" Dense="true">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Returned Products</MudText>
        <MudSpacer />        
        @if (Data!.Any())
        {
            <MudChip T="string" Color="Color.Error">Total Refund: @((Data!.Sum(x => x.Cost * x.Quantity).GetValueOrDefault() - Deduction).ToString("N2"))</MudChip>
        }
    </ToolBarContent>
    <Columns>
        <PropertyColumn Property="x=>x.Date" Title="Return Date" />
        <PropertyColumn Property="x=>x.Product!.Item!.ProductName" Title="Product" />
        <PropertyColumn Property="x=>x.Quantity" Title="Quantity" />
        <TemplateColumn Title="Status" Context="ctx">
            <CellTemplate>
                <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Wrap="Wrap.Wrap">                    
                    @if (ctx.Item.Status == RefundPaymentStatus.Paid)
                    {
                        <MudChip Size="Size.Small" Color="Color.Success">Paid</MudChip>                        
                    }
                    else
                    {
                        <MudChip Size="Size.Small" Color="Color.Error">Unpaid</MudChip>
                        <MudTooltip Duration="1000" Placement="Placement.Top" Text="Mark as paid">
                             <MudButton Disabled="@AppState.IsProcessing" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle"
                                OnClick="@(() => MarkAsPaid(ctx.Item))">
                                Mark as paid
                                </MudButton>
                        </MudTooltip>
                    }
                </MudStack>
            </CellTemplate>
        </TemplateColumn> 
        <PropertyColumn Property="x=>x.ModifiedDate" Title="Modified Date" />
        <TemplateColumn Context="stx">
            <CellTemplate>
                @* <MudFab Size="Size.Small" Icon="@Icons.Material.Filled.Edit" OnClick="@(() => EditStock(StockContext))" /> *@
                <MudIconButton Disabled="@AppState.IsProcessing" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.Delete"
                        OnClick="@(() => Delete(stx.Item))" />
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <NoRecordsContent>
        <MudText Typo="Typo.h6">Empty record</MudText>
    </NoRecordsContent>
    <PagerContent>
        <MudDataGridPager T="ReturnedProduct" />
    </PagerContent>
</MudDataGrid>


@code {
    [Parameter]
    public ReturnedProduct[]? Data { get; set; } = [];
    [Parameter]
    public decimal Deduction { get; set; } = 0;

    public async Task MarkAsPaid(ReturnedProduct product)
    {
        AppState.IsProcessing = true;
        bool? result = await Dialog.ShowMessageBox("Confirmation",
        $"Do you wish to Mark this refund as paid?", yesText: "Yes", cancelText: "No");
        if (result is null)
        {
            AppState.IsProcessing = false;
            return;
        }
        else if (!result.Value)
        {
            AppState.IsProcessing = false;
            return;
        }

        try
        {
            bool response = await Service.Put(product);
            SnackBar.Add($"Record Successfully Updated!", Severity.Success);
            AppState.UpdateLayout();
        }
        catch (System.Exception ex)
        {
            Console.WriteLine(ex.Message);
            SnackBar.Add($"Error occured!", Severity.Error);
        }
        finally
        {
            AppState.IsProcessing = false;
        }
    }
    async Task Delete(ReturnedProduct product)
    {
        AppState.IsProcessing = true;
        bool? result = await Dialog.ShowMessageBox("Confirmation",
        $"Do you wish to Delete?", yesText: "Yes", cancelText: "No");
        if (result is null)
        {
            AppState.IsProcessing = false;
            return;
        }
        else if (!result.Value)
        {
            AppState.IsProcessing = false;
            return;
        }

        try
        {
            await Service.Delete(product!.Id);
            SnackBar.Add($"Record Successfully Deleted!", Severity.Success);
            AppState.UpdateLayout();
        }
        catch (System.Exception ex)
        {
            Console.WriteLine(ex.Message);
            SnackBar.Add($"Error occured!", Severity.Error);
        }
        finally
        {
            AppState.IsProcessing = false;
        }
    }

}