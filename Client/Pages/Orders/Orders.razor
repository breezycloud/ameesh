@using Shared.Enums
@attribute [Authorize]
@inject IOrderService OrderService
@inject IStoreService StoreService
@inject IJSRuntime js
@implements IAsyncDisposable

<MudDataGrid T="OrderWithData"
             @ref="_gridComponent"             
             ServerData="GetGridData"
             RowClick="@HandleSelectedDataItemChanged"
             @bind-SelectedDataItem="data"
             Dense             
             Outlined>
    <ToolBarContent>
        <MudSpacer />
        <MudTextField T="string" Value="AppState._searchString" ValueChanged="@(s => OnSearch(s))" Placeholder="Search by receipt no, customer name, delivery state" Immediate="false"
                      Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <Columns>        
        <PropertyColumn Property="x => x.CustomerName" Title="Name" CellStyleFunc="_cellStyleFunc" />
        <PropertyColumn Property="x => x.Date" Title="Date" Format="dd/MM/yyyy" />
        <PropertyColumn Property="x => x.CreatedDate.ToShortTimeString()" Title="Time" />
        <PropertyColumn Property="x => x.TotalAmount" Title="Total" Format="N2" />
        <PropertyColumn Property="x => x.Discount" Title="Discount" Format="N2" />
        <PropertyColumn Property="x => x.SubTotal" Title="Sub Total" Format="N2" />
        <TemplateColumn Title="Status" Context="ctx">
            <CellTemplate>
                <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Wrap="Wrap.Wrap">                    
                    @if (ctx.Item.PaymentStatus == "Paid")
                    {
                        <MudChip Size="Size.Small" Color="Color.Success">Paid</MudChip>                        
                    }
                    else if (ctx.Item.PaymentStatus == "Awaiting")
                    {
                        <MudChip Size="Size.Small" OnClick="() => Complete(ctx.Item.Id)" Color="Color.Warning">Awaiting Confirmation</MudChip>                        
                    }
                    else
                    {
                        <MudChip Size="Size.Small" Color="Color.Error">Unpaid</MudChip>
                    }
                    @if (ctx.Item.HasDelievery)
                    {
                        <MudChip Size="Size.Small">@ctx.Item.DeliveryStatus</MudChip>
                        @if (ctx.Item.Delivered)
                        {
                            <MudChip Size="Size.Small" Color="Color.Primary">Delivered</MudChip>
                        }
                        <AuthorizeView Roles="Cashier" Context="auth">
                            @if (!ctx.Item.Dispatched)
                            {
                                <MudButton StartIcon="@Icons.Material.Filled.DeliveryDining" Color="Color.Info" OnClick="() => Dispatch(ctx.Item.Id)" Size="Size.Small">Dispatch</MudButton>
                            }
                            @if (ctx.Item.Dispatched && !ctx.Item.Delivered)
                            {
                                <MudButton StartIcon="@Icons.Material.Filled.CheckCircle" Color="Color.Info" OnClick="() => Delivered(ctx.Item.Id)" Size="Size.Small">
                                    Delivered
                                </MudButton>
                            }
                        </AuthorizeView>
                    }
                </MudStack>
            </CellTemplate>
        </TemplateColumn>  
        <AuthorizeView Roles="Admin, Master" Context="auth">
            <Authorized>							
                <TemplateColumn>
                    <CellTemplate>
                        @if (context.Item.PaymentStatus == "Awaiting")
                        {
                            <MudButton Color="Color.Success" OnClick="() => Complete(context.Item.Id)" Size="Size.Small">Confirm</MudButton>
                        }
                        @if (context.Item.HasDelievery && !context.Item.Dispatched)
                        {
                            <MudButton Color="Color.Info" OnClick="() => Dispatch(context.Item.Id)" Size="Size.Small">Dispatch</MudButton>
                        }
                        @if (context.Item.Dispatched && !context.Item.Delivered)
                        {
                            <MudButton StartIcon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" OnClick="() => Delivered(context.Item.Id)" Size="Size.Small">
                                Delivered
                            </MudButton>
                        }
                        <MudButton Color="Color.Secondary" OnClick="() => OnDelete(context.Item.Id)" Size="Size.Small">Delete</MudButton>
                    </CellTemplate>
                </TemplateColumn>
            </Authorized>
        </AuthorizeView>      
    </Columns>
    <NoRecordsContent>
        <MudText Typo="Typo.h6">No records found</MudText>
    </NoRecordsContent>
    <PagerContent>
        <MudDataGridPager T="OrderWithData" />
    </PagerContent>
</MudDataGrid>

@code {
    private MudDataGrid<OrderWithData>? _gridComponent;
    private OrderWithData? data;    
    private string searchString = "";
    private string? timer = "";
    private HubConnection? hub;

    protected override async Task OnInitializedAsync()
    {
        hub = new HubConnectionBuilder().WithUrl(nav.ToAbsoluteUri("/hubs")).WithStatefulReconnect().Build();
        await hub.StartAsync();
        hub!.On("RefreshOrderTimer", async () =>
        {
            await _gridComponent!.ReloadServerData();
        });        
    }

    private async Task Dispatch(Guid id)
    {
        AppState.IsProcessing = true;
		//var mode = await localStorage.GetItemAsync<bool>("mode");
		var prompt = await Dialog.ShowMessageBox("Confirmation", "Do you really wish to dispatch order", yesText: "Yes", cancelText: "No");
		if (prompt is null)
		{
			AppState.IsProcessing = false;
			return;
		}

		try
		{
			await OrderService.DispatchOrder(id);
			SnackBar.Add("Order Successfully Updated", Severity.Success);
			if (hub!.State != HubConnectionState.Disconnected)
            {
                await hub!.SendAsync("RefreshOrderTimer");
                await hub!.SendAsync("UpdateOrder");                    
            }
		}
		catch (Exception ex)
		{
			Console.WriteLine(ex.Message);
			SnackBar.Add("Operation failed", Severity.Warning);
		}
		finally
		{
			AppState.IsProcessing = false;
		}
    }

    private async Task Delivered(Guid id)
    {
        AppState.IsProcessing = true;
		//var mode = await localStorage.GetItemAsync<bool>("mode");
		var prompt = await Dialog.ShowMessageBox("Confirmation", "Do you really wish to mark as delivered", yesText: "Yes", cancelText: "No");
		if (prompt is null)
		{
			AppState.IsProcessing = false;
			return;
		}

		try
		{
			await OrderService.DeliveredOrder(id);
			SnackBar.Add("Order Successfully Updated", Severity.Success);
			if (hub!.State != HubConnectionState.Disconnected)
            {
                await hub!.SendAsync("RefreshOrderTimer");
                await hub!.SendAsync("UpdateOrder");                    
            }
		}
		catch (Exception ex)
		{
			Console.WriteLine(ex.Message);
			SnackBar.Add("Operation failed", Severity.Warning);
		}
		finally
		{
			AppState.IsProcessing = false;
		}
    }

    private async Task<GridData<OrderWithData>> GetGridData(GridState<OrderWithData> request)
    {                
        var parameter = new PaginationParameter { FilterId = AppState.StoreID, Page = request.Page * request.PageSize, PageSize = request.PageSize };
        if (!string.IsNullOrEmpty(AppState._searchString))
            parameter.SearchTerm = AppState._searchString;
        var response = await OrderService.GetOrderByStore(AppState.SelectedOption!, parameter);
        return new GridData<OrderWithData>()
        {
            Items = response!.Data!.OrderByDescending(x => x.ModifiedDate)!,
            TotalItems = response.TotalCount
        };
    }

    void HandleSelectedDataItemChanged(DataGridRowClickEventArgs<OrderWithData> item)
    {
        OnExpand(item.Item.Id);
    }

    private Func<OrderWithData, string> _cellStyleFunc => x =>
    {
        string style = "";

        if (x.IsHasDiscount && x.Balance > 0)
            style += "color:red";
        else if  (x.DiscountAboveLimit())
            style += "color:red";
        else if  (x.HasReturns)
            style += "color:red";
        else
            style += "";
        return style;
    };

    private async Task PrintSlip(string receipt)
    {
        bool connected = await js.InvokeAsync<bool>("XPrinter.Initialize");
        if (connected)
            await OrderService.PrintBill(receipt!);
    }

    async Task ReloadServerData()
    {
        await _gridComponent!.ReloadServerData();
        StateHasChanged();
    }

    void OnExpand(Guid id)
    {
        nav.NavigateTo($"order/{id}");
    }

    async void OnSearch(string text)
    {
        if (string.IsNullOrEmpty(text))
            AppState._searchString = string.Empty;
        else
            AppState._searchString = text;

        await _gridComponent!.ReloadServerData();
    }

    async Task Print(Guid id)
    {
        AppState.IsProcessing = true;
        // var report = await OrderService.GetReportData(id);
        // await OrderService.GetReceipt(report);
        await Task.Delay(100);
        AppState.IsProcessing = false;
    }

    async Task Complete(Guid id)
    {
        AppState.IsProcessing = true;      
        var prompt = await Dialog.ShowMessageBox("Confirmation", "Do you really wish to confirm payment", yesText: "Yes", cancelText: "No");
		if (prompt is null)
		{
			AppState.IsProcessing = false;
			return;
		}
        var result = await OrderService.CompleteOrder(id);
        if (result)
        {
            if (hub!.State != HubConnectionState.Disconnected)
            {
                await hub!.SendAsync("RefreshOrderTimer");
                await hub!.SendAsync("UpdateOrder");                    
            }
        }
        AppState.IsProcessing = false;
    }

    private async Task OnDelete(Guid id)
	{
		AppState.IsProcessing = true;
		var mode = await localStorage.GetItemAsync<bool>("mode");
		var prompt = await Dialog.ShowMessageBox("Confirmation", "Do you really wish to delete", yesText: "Yes", cancelText: "No");
		if (prompt is null)
		{
			AppState.IsProcessing = false;
			return;
		}

		try
		{
			await OrderService.Delete(id);
			SnackBar.Add("Order Successfully Deleted", Severity.Success);
			if (hub!.State != HubConnectionState.Disconnected)
            {
                await hub!.SendAsync("RefreshOrderTimer");
                await hub!.SendAsync("UpdateOrder");                    
            }
		}
		catch (Exception ex)
		{
			Console.WriteLine(ex.Message);
			SnackBar.Add("Operation failed", Severity.Warning);
		}
		finally
		{
			AppState.IsProcessing = false;
		}
	}
    
    public async ValueTask DisposeAsync()
    {
        await hub!.StopAsync();
        await hub!.DisposeAsync();
    }
}
